<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>First Person WebGL Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; }
        canvas { display: block; }
    </style>
</head>
<body>
    <noscript>
        This game requires JavaScript to run. Please enable JavaScript in your browser settings.
    </noscript>
    <script>
        /* global THREE */
        let scene, camera, renderer, player, flashlight, flashlightSound;
        const moveSpeed = 0.05;
        const sprintSpeed = 0.1;
        const keys = {};
        let mouseX = 0, mouseY = 0;
        const sensitivity = 0.001;
        let velocity = new THREE.Vector3();
        let jumping = false;
        let footstepSound;
        let isMoving = false;
        const jumpForce = 0.2;
        const gravity = -0.01;
        const mapSize = 100;
        const numberOfTrees = 100;
        let flashlightOn = false;
        const flashlightIntensity = 5;
        const fogNearWithoutFlashlight = 0.1;
        const fogFarWithoutFlashlight = 10;
        let stamina = 100;
        const maxStamina = 100;
        const staminaDecreaseRate = 0.5;
        const staminaIncreaseRate = 0.25;
        let sprinting = false;
        let ambienceSound;
        let jumpscareImage, jumpscareSound;
        let jumpscareTimeout;
        
        function init() {
            // Create scene
            scene = new THREE.Scene();
        
            // Create camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.y = 1.6; // Average human eye level
        
            // Create renderer
            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
        
            // Create ground
            const groundGeometry = new THREE.PlaneGeometry(200, 200);
            const textureLoader = new THREE.TextureLoader();
            const groundTexture = textureLoader.load('https://static.vecteezy.com/system/resources/previews/008/289/677/non_2x/seamless-ground-pattern-with-grass-soil-texture-with-plants-for-wallpaper-illustration-of-natural-lawn-background-for-game-gui-vector.jpg');
            groundTexture.wrapS = THREE.RepeatWrapping;
            groundTexture.wrapT = THREE.RepeatWrapping;
            groundTexture.repeat.set(20, 20);
            const groundMaterial = new THREE.MeshBasicMaterial({ map: groundTexture });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            scene.add(ground);

            // Create tree shafts
            const treeShaftTexture = textureLoader.load('https://i.postimg.cc/ZRwHkXz6/8a85d2362a637a92522e5ad54208bd4f.jpg');
            const treeLeafTexture = textureLoader.load('https://i.postimg.cc/05HnVgfs/8a85d2362a637a92522e5ad54208bd4f.jpg');
            const treeShaftMaterial = new THREE.MeshBasicMaterial({ map: treeShaftTexture, side: THREE.DoubleSide });
            const treeLeafMaterial = new THREE.MeshBasicMaterial({ map: treeLeafTexture, side: THREE.DoubleSide });
            const treeShaftGeometry = new THREE.CylinderGeometry(0.5, 0.5, 5, 8);
            const treeConeGeometry = new THREE.ConeGeometry(2, 5, 8);
            
            for (let i = 0; i < numberOfTrees; i++) {
                const x = Math.random() * mapSize - mapSize / 2;
                const z = Math.random() * mapSize - mapSize / 2;
                const treeShaft = new THREE.Mesh(treeShaftGeometry, treeShaftMaterial);
                treeShaft.position.set(x, 2.5, z);
                scene.add(treeShaft);
                
                const treeCone = new THREE.Mesh(treeConeGeometry, treeLeafMaterial);
                treeCone.position.set(x, 7.5, z);
                scene.add(treeCone);
            }
        
            // Create player
            player = new THREE.Object3D();
            player.add(camera);
            scene.add(player);
            player.position.y = 1.6; // Set initial player height
        
            // Create flashlight
            flashlight = new THREE.SpotLight(0xffffff, flashlightIntensity, 20, Math.PI / 8, 0.5, 1);
            flashlight.position.set(0, 0, 0);
            flashlight.target.position.set(0, 0, -1);
            player.add(flashlight);
            player.add(flashlight.target);
            flashlight.visible = false;
            flashlight.intensity = flashlightIntensity * 0.8; // Reduce flashlight intensity by 20%
        
            // Add very dark, extremely dense fog
            scene.fog = new THREE.Fog(0x000000, fogNearWithoutFlashlight, fogFarWithoutFlashlight);
        
            // Event listeners
            window.addEventListener('resize', onWindowResize, false);
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
            document.addEventListener('mousemove', onMouseMove);
            
            // Lock pointer
            renderer.domElement.requestPointerLock = renderer.domElement.requestPointerLock ||
                                                     renderer.domElement.mozRequestPointerLock;
            renderer.domElement.onclick = function() {
                renderer.domElement.requestPointerLock();
            };
        
            // Load and set up ambience sound
            const listener = new THREE.AudioListener();
            camera.add(listener);
            ambienceSound = new THREE.Audio(listener);
            const audioLoader = new THREE.AudioLoader();
            audioLoader.load('https://audio.jukehost.co.uk/oxzM7oHUUuMF4pvAGuS5xkgL5ntXY7eZ', function(buffer) {
                ambienceSound.setBuffer(buffer);
                ambienceSound.setLoop(true);
                ambienceSound.setVolume(0.5);
                ambienceSound.play();
            });
            
            // Load footstep sound
            footstepSound = new THREE.Audio(listener);
            audioLoader.load('https://audio.jukehost.co.uk/CTteleYQ8UHXskHHN3LbYdJfMNmSFSxR', function(buffer) {
                footstepSound.setBuffer(buffer);
                footstepSound.setLoop(true);
                footstepSound.setVolume(0.3);
            });
            
            // Load flashlight toggle sound
            flashlightSound = new THREE.Audio(listener);
            audioLoader.load('https://audio.jukehost.co.uk/UcCR7pDRLBbCPzNljYcxhSxc7VT4Z9fh', function(buffer) {
                flashlightSound.setBuffer(buffer);
                flashlightSound.setVolume(0.32); // Reduced volume by 20% (from 0.4 to 0.32)
            });
        
            // Load jumpscare image and sound
            jumpscareImage = new Image();
            jumpscareImage.src = 'https://i.postimg.cc/QCRnPvc0/dfwjpnu-80256d7e-9228-4067-9c71-f9d55a99d59b.png';
            jumpscareSound = new Audio('https://audio.jukehost.co.uk/iY2eOhUHO7lYxkPa1qmo6ndcfQ1279Pi');
        
            animate();
            scheduleJumpscare();
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        function onKeyDown(event) {
            keys[event.code] = true;
            if (event.code === 'Space' && !jumping) {
                jumping = true;
                velocity.y = jumpForce;
            }
            if (event.code === 'KeyF') {
                flashlightOn = !flashlightOn;
                flashlight.visible = flashlightOn;
                flashlightSound.play(); // Play flashlight toggle sound
                if (flashlightOn) {
                    scene.fog.far = 20; // Increase fog distance when flashlight is on
                } else {
                    scene.fog.far = fogFarWithoutFlashlight; // Reset fog distance when flashlight is off
                }
            }
            if (event.code === 'ShiftLeft' && stamina > 0) {
                sprinting = true;
            }
        }
        
        function onKeyUp(event) {
            keys[event.code] = false;
            if (event.code === 'ShiftLeft') {
                sprinting = false;
            }
        }
        
        function onMouseMove(event) {
            if (document.pointerLockElement === renderer.domElement ||
                document.mozPointerLockElement === renderer.domElement) {
                mouseX += event.movementX || event.mozMovementX || 0;
                mouseY += event.movementY || event.mozMovementY || 0;
                player.rotation.y -= mouseX * sensitivity;
                camera.rotation.x = Math.max(-Math.PI / 3, Math.min(Math.PI / 3, camera.rotation.x - mouseY * sensitivity));
                mouseX = 0;
                mouseY = 0;
            }
        }
        
        function animate() {
            requestAnimationFrame(animate);
        
            // Apply gravity
            if (jumping) {
                velocity.y += gravity;
                player.position.y += velocity.y;
                if (player.position.y <= 1.6) {
                    player.position.y = 1.6;
                    jumping = false;
                    velocity.y = 0;
                }
            }
        
            // Move player
            const oldPosition = player.position.clone();
            const currentSpeed = sprinting && stamina > 0 ? sprintSpeed : moveSpeed;
            isMoving = false;
            if (keys['KeyW']) { player.translateZ(-currentSpeed); isMoving = true; }
            if (keys['KeyS']) { player.translateZ(currentSpeed); isMoving = true; }
            if (keys['KeyA']) { player.translateX(-currentSpeed); isMoving = true; }
            if (keys['KeyD']) { player.translateX(currentSpeed); isMoving = true; }
        
            // Play footstep sound if moving
            if (isMoving && !jumping) {
                if (!footstepSound.isPlaying) {
                    footstepSound.play();
                }
            } else {
                footstepSound.pause();
            }
        
            // Check for collisions with tree shafts
            scene.children.forEach(child => {
                if (child instanceof THREE.Mesh && child.geometry instanceof THREE.CylinderGeometry && child.geometry.parameters.radiusTop === 0.5) {
                    const distance = player.position.distanceTo(child.position);
                    if (distance < 1) { // Adjust this value based on the size of your tree shafts and player
                        player.position.copy(oldPosition);
                    }
                }
            });
        
            // Handle stamina
            if (sprinting && stamina > 0) {
                stamina -= staminaDecreaseRate;
                if (stamina < 0) stamina = 0;
            } else if (!sprinting && stamina < maxStamina) {
                stamina += staminaIncreaseRate;
                if (stamina > maxStamina) stamina = maxStamina;
            }
        
            renderer.render(scene, camera);
        }
        
        // Removed playAmbienceSound function as it's no longer needed
        
        function scheduleJumpscare() {
            const minDelay = 20000; // 20 seconds
            const maxDelay = 50000; // 50 seconds
            const delay = Math.random() * (maxDelay - minDelay) + minDelay;
            jumpscareTimeout = setTimeout(triggerJumpscare, delay);
        }
        
        function triggerJumpscare() {
            const jumpscareElement = document.createElement('div');
            jumpscareElement.style.position = 'fixed';
            jumpscareElement.style.top = '0';
            jumpscareElement.style.left = '0';
            jumpscareElement.style.width = '100%';
            jumpscareElement.style.height = '100%';
            jumpscareElement.style.backgroundImage = `url(${jumpscareImage.src})`;
            jumpscareElement.style.backgroundSize = 'cover';
            jumpscareElement.style.backgroundPosition = 'center';
            jumpscareElement.style.zIndex = '1000';
            document.body.appendChild(jumpscareElement);
        
            jumpscareSound.play();
        
            setTimeout(() => {
                document.body.removeChild(jumpscareElement);
                scheduleJumpscare();
            }, 3000);
        }
        
        init();
    </script>
</body>
</html>
